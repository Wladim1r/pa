services:
  zookeeper:
    hostname: zookeeper
    image: bitnamilegacy/zookeeper:latest
    container_name: zookeeper
    restart: always
    ports:
      - "2181:2181"
    environment:
      ALLOW_ANONYMOUS_LOGIN: yes
    networks:
      - crypto-network
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "2181"]
      interval: 5s
      timeout: 3s
      retries: 5

  kafka:
    hostname: kafka
    image: bitnamilegacy/kafka:2.7.0
    container_name: kafka
    restart: always
    depends_on:
      zookeeper:
        condition: service_healthy
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENERS: PLAINTEXT://:9092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      ALLOW_PLAINTEXT_LISTENER: yes
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
    networks:
      - crypto-network
    volumes:
      - kafka-data:/bitnami/kafka
    healthcheck:
      test:
        [
          "CMD",
          "kafka-broker-api-versions.sh",
          "--bootstrap-server",
          "localhost:9092",
        ]
      interval: 5s
      timeout: 10s
      retries: 10

  kafka-init:
    image: bitnamilegacy/kafka:2.7.0
    container_name: kafka-init
    depends_on:
      kafka:
        condition: service_healthy
    networks:
      - crypto-network
    command: >
      bash -c "
      echo '‚è≥ Waiting for Kafka to be fully ready...' &&
      sleep 15 &&
      echo 'üìù Creating topic binance.miniticker...' &&
      kafka-topics.sh --create --if-not-exists --bootstrap-server kafka:9092 --replication-factor 1 --partitions 3 --topic binance.miniticker &&
      echo '‚úÖ Topic created successfully!' &&
      echo 'üìã Listing all topics:' &&
      kafka-topics.sh --list --bootstrap-server kafka:9092 &&
      echo '‚úÖ Kafka initialization complete'
      "
    restart: "no"

  socket-service:
    build: ./Socket-service/
    container_name: socket-service
    restart: always
    ports:
      - "50051:50051"
    networks:
      - crypto-network

  aggregator-service:
    build: ./Aggregator/
    container_name: aggregator-service
    restart: on-failure:5
    depends_on:
      kafka-init:
        condition: service_completed_successfully
      socket-service:
        condition: service_started
    ports:
      - "50061:50061"
    environment:
      BROKERS: "kafka:9092"
      TOPIC: "binance.miniticker"
      BATCH_SIZE: "120"
      BATCH_TIMEOUT: "2s"
      ACK: "1"
      MAX_ATTEMPTS: "3"
      WRITE_TIMEOUT: "30s"
    networks:
      - crypto-network

  kafka-clickhouse:
    build: ./Kafka-Clickhouse/
    container_name: kafka-clickhouse
    restart: on-failure:5
    depends_on:
      aggregator-service:
        condition: service_started
    ports:
      - "50071:50071"
    environment:
      # Kafka settings
      KAFKA_BROKERS: "kafka:9092"
      KAFKA_TOPIC: "binance.miniticker"
      KAFKA_GROUP_ID: "clickhouse-consumer-group"
      KAFKA_MAX_RETRIES: "5"
      KAFKA_RETRY_DELAY: "2s"
      KAFKA_SESSION_TIMEOUT: "10s"
      KAFKA_HEARTBEAT_INTERVAL: "3s"
    networks:
      - crypto-network

volumes:
  kafka-data:

networks:
  crypto-network:
    driver: bridge
